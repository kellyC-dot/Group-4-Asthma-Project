---
title: "Milestone 3"
author: "Avinia, Eve, Kelly"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## R Markdown


```{r}

# Import dataset 1, 2 and 3 (Avinia to confirm if dataset 3 OK)

library(tidyverse)
library(dplyr)
library(readr)
library(janitor)

# Read Dataset 1 CSV with the specified arguments
asthma_measures <- readr::read_csv("data/calenviroscreen_measures_2021.csv", 
                            col_names = TRUE, 
                            col_types = NULL, 
                            skip = 0, 
                            skip_empty_rows = TRUE,
                            na = "NA")

# Then clean the names using janitor
asthma_measures <- janitor::clean_names(asthma_measures)

# next work with Dataset 2...
# Read Dataset 2 CSV with the specified arguments
asthma_scores_demog <- readr::read_csv("data/calenviroscreen_scores_demog_2021.csv", 
                            col_names = TRUE, 
                            col_types = NULL, 
                            skip = 0, 
                            skip_empty_rows = TRUE)

# Then clean the names using janitor
asthma_scores_demog <- janitor::clean_names(asthma_scores_demog)

# next work with Dataset 3...
# Read Dataset 3 CSV with the specified arguments
asthma_ER_rate_county <- readr::read_csv("data/asthma-emergency-department-visit-rates-by-county-2015_2022.csv", 
                            col_names = TRUE, 
                            col_types = NULL, 
                            skip = 0, 
                            skip_empty_rows = TRUE)

# Then clean the names using janitor
asthma_ER_rate_county <- janitor::clean_names(asthma_ER_rate_county)

print(asthma_measures);print(asthma_scores_demog);print(asthma_ER_rate_county)

```


## Dataset 1 Code:

```{r}

# Change to lower case and underscore, and rename column

asthma_measures_df <- asthma_measures %>% rename_with(~tolower(gsub(" ", "_", .x, fixed = TRUE)))

asthma_measures_df1 <- asthma_measures_df %>% 
  rename(county = california_county)


# selecting variables of interest, (11 variables, 8035 obs.)

asthma_measures_df2a <- asthma_measures_df1 %>% 
  select(census_tract, county, pm2_5, diesel_pm, 
         traffic, tox_release, asthma, housing_burden, 
         education, unemployment, poverty) 


# Remove rows with NA values in columns

asthma_measures_df2a_clean <- 
  asthma_measures_df2a[!is.na(asthma_measures_df2a$asthma) & !is.na(asthma_measures_df2a$pm2_5) & !is.na(asthma_measures_df2a$diesel_pm) & !is.na(asthma_measures_df2a$traffic) & !is.na(asthma_measures_df2a$tox_release) & !is.na(asthma_measures_df2a$housing_burden) & !is.na(asthma_measures_df2a$education) & !is.na(asthma_measures_df2a$unemployment) & !is.na(asthma_measures_df2a$poverty), ]


# Aggregate measure: median asthma rates and environmental variables by county 

asthma_measures_df3a <- asthma_measures_df2a_clean %>% 
  group_by(county) %>% 
  summarize(
    asthma_median_by_county = median(asthma, na.rm = TRUE),
    pm2_5_median_by_county = median(pm2_5, na.rm = TRUE),
    diesel_pm_median_by_county = median(diesel_pm, na.rm = TRUE),
    traffic_median_by_county = median(traffic, na.rm = TRUE),
    tox_release_median_by_county = median(tox_release, na.rm = TRUE),
    .groups = "drop"
  ) %>% 
  ungroup()
asthma_measures_df3a <- asthma_measures_df3a %>% 
  arrange(desc(asthma_median_by_county))


# Aggregate measure: median asthma rates and population characteristics 
# by county

asthma_measures_df3b <- asthma_measures_df2a_clean %>% 
  group_by(county) %>% 
  summarize(
    asthma_median_by_county = median(asthma, na.rm = TRUE),
    housing_burden_median_by_county = median(housing_burden, na.rm = TRUE),
    education_median_by_county = median(education, na.rm = TRUE),
    unemployment_median_by_county = median(unemployment, na.rm = TRUE),
    poverty_median_by_county = median(poverty, na.rm = TRUE),
    .groups = "drop"
  ) %>% 
  ungroup()
asthma_measures_df3b <- asthma_measures_df3b %>% 
  arrange(desc(asthma_median_by_county))

```

## Dataset 1 Tables and plot

```{r}

library(dplyr)
library(kableExtra)

# Median Asthma Rates and Environmental Factors by County

asthma_measures_df3a %>%
  setNames(c("County", "Asthma", "PM 2.5", "Diesel", "Traffic", "Toxic Release")) %>%  # rename columns
  mutate(across(c(Asthma, `PM 2.5`, Diesel, Traffic, `Toxic Release`), ~ round(.x, 3))) %>%  # Round columns to 3 digits
  kable(caption = "Median Asthma Rates and Environmental Factors by County") %>%  kable_styling(
    bootstrap_options = c("striped", "hover"),
    position = "center",
    full_width = FALSE
  ) %>%
  column_spec(1:ncol(asthma_measures_df3a), width = "5em") 
```


```{r}
# Median Asthma Rates and Population Characteristics by County

asthma_measures_df3b %>%
  setNames(c("County", "Asthma", "Housing Burden", "Education", "Unemployment", "Poverty")) %>%  # rename columns
  mutate(across(c(Asthma, `Housing Burden`, Education, Unemployment, Poverty), ~ round(.x, 3))) %>%  # Round columns to 3 digits
  kable(caption = "Median Asthma Rates and Population Characteristics by County") %>%  kable_styling(
    bootstrap_options = c("striped", "hover"),
    position = "center",
    full_width = FALSE
  ) %>%
  column_spec(1:ncol(asthma_measures_df3a), width = "5em")  
```


```{r}
# Data for plot Median Asthma Rates per County

asthma_measures_df13a <- asthma_measures_df3a %>%
mutate(county = factor(county, levels = county[order(asthma_median_by_county)]))

# Plotting

ggplot(asthma_measures_df13a, aes(x = county, y = asthma_median_by_county)) +
  geom_point() +  # Scatter plot points
  labs(
    x = "County",
    y = "Asthma Median",
    title = "Scatter Plot of Asthma Median per County"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1)  # Rotate x-axis labels
  )

```

## Dataset 2 Code:

```{r}
# In Dataset 2, standardize County names (remove spaces or case mismatches)
asthma_scores_demog <- asthma_scores_demog %>%
  clean_names()

```
## Dataset 3 - Asthma Emergency Department Visits Dataset Description
This dataset contains information on asthma-related emergency department (ED) visits across counties, with a focus on demographic breakdowns by race/ethnicity and age group. The dataset has been filtered to include data only from the year 2019. Key variables in this dataset include the number of ED visits and an age-adjusted ED visit rate to account for age distribution differences across counties. The chosen variables provide a comprehensive view of ED utilization due to asthma across various demographic groups. 

Additionally, calculating mean age-adjusted rates enables standardized comparisons across counties, adjusting for age-related differences that might otherwise skew results. By aggregating data by race/ethnicity and age group, we can explore potential disparities and patterns related to asthma.

## Dataset 3 Code:
```{r}
# Change to the lower case
asthma_ER_rate_county <- asthma_ER_rate_county %>%
  rename_with(~tolower(gsub(" ", "_", .x, fixed = TRUE)))

# Select Demographic Data of Interest
asthma_ed_visits_2019 <- asthma_ER_rate_county %>%
  filter(year == 2019, county != "California") %>%
  select(county, strata_name, age_group, number_of_ed_visits, `age_adjusted_ed_visit_rate`)

# Recode values that are reading in incorrectly
# Clean non-ASCII characters in 'strata_name' and identify 'age_group' and 'race_ethnicity'
asthma_ed_visits_2019 <- asthma_ed_visits_2019 %>%
  mutate(
    strata_name = str_replace_all(strata_name, "[^\x20-\x7E]", "-"),  # Replace non-ASCII characters
    age_group = case_when(
      strata_name %in% c("0-4 years", "5-17 years", "0-17 years", "18-64 years", "18+ years", "65+ years", "All ages") ~ strata_name,
      TRUE ~ NA_character_
    ),
    race_ethnicity = case_when(
      strata_name %in% c("White", "Black", "Hispanic", "Asian/PI", "AI/AN", "NHPI", "Multi-Race") ~ strata_name,
      TRUE ~ NA_character_
    )
  )

# Subset to most recent year and county level data
# Create a new variable 'age_category' based on the cleaned 'age_group'
asthma_ed_visits_2019 <- asthma_ed_visits_2019 %>%
  mutate(age_category = case_when(
    age_group %in% c("0-4 years", "5-17 years", "0-17 years") ~ "Children (0-17 years)",
    age_group %in% c("18-64 years", "18+ years") ~ "Adults (18-64 years)",
    age_group == "65+ years" ~ "Seniors (65+ years)",
    age_group == "All ages" ~ "All Ages",
    TRUE ~ "Unknown"
  ))

# Replace NA values in necessary columns
asthma_ed_visits_2019_clean <- asthma_ed_visits_2019 %>%
  mutate(
    age_group = replace_na(age_group, "Unknown"),
    race_ethnicity = replace_na(race_ethnicity, "Unknown"),
    age_category = replace_na(age_category, "Unknown")
  )

```

# Table and Plot
```{r}
library(dplyr)
library(knitr)
library(kableExtra)

# Pivot table to only include one row per county
county_ed_visits_summary <- asthma_ed_visits_2019_clean %>%
  group_by(county) %>%
  summarize(
    total_ed_visits = round(sum(number_of_ed_visits, na.rm = TRUE), 2),
    mean_ed_visits = round(mean(number_of_ed_visits, na.rm = TRUE), 2),
    mean_age_adjusted_rate = round(mean(`age_adjusted_ed_visit_rate`, na.rm = TRUE), 2),
    .groups = "drop"
  ) %>%
  rename(
    County = county,
    `Total ED Visits` = total_ed_visits,
    `Mean ED Visits` = mean_ed_visits,
    `Mean Age-Adjusted Rate` = mean_age_adjusted_rate
  )

# Create Table
kable(county_ed_visits_summary, caption = "**Table: Total and Mean ED Visits, and Mean Age-Adjusted Rate per County**") %>%
  kable_styling(position = "center", full_width = FALSE)

```



```{r}
# County Data ED Visits (Descriptive Data)
library(dplyr)
library(knitr)
library(kableExtra)

# Create a new data frame summarizing total ED visits per county
county_ed_visits_plot_data <- asthma_ed_visits_2019_clean %>%
  group_by(county) %>%
  summarize(
    total_ed_visits = sum(number_of_ed_visits, na.rm = TRUE),
    .groups = "drop"
  )

print(county_ed_visits_plot_data)

# Create Plot
ggplot(county_ed_visits_plot_data, aes(x = reorder(county, -total_ed_visits), y = total_ed_visits)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  labs(
    title = "Total ED Visits per County",
    x = "County",
    y = "Total ED Visits"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

```{r}
# Descriptive Data Age Adjusted Rate
library(dplyr)
library(ggplot2)

# Create a new data frame summarizing mean age-adjusted ED visit rate per county
county_age_adjusted_rate_data <- asthma_ed_visits_2019_clean %>%
  group_by(county) %>%
  summarize(
    mean_age_adjusted_rate = mean(`age_adjusted_ed_visit_rate`, na.rm = TRUE),
    .groups = "drop"
  )

print(county_age_adjusted_rate_data)

# Plot mean age-adjusted ED visit rate per county
ggplot(county_age_adjusted_rate_data, aes(x = reorder(county, -mean_age_adjusted_rate), y = mean_age_adjusted_rate)) +
  geom_bar(stat = "identity", fill = "lightcoral") +
  labs(
    title = "Mean Age-Adjusted ED Visit Rate per County",
    x = "County",
    y = "Mean Age-Adjusted Rate"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))  # Rotate x-axis labels for readability
```

```{r}
# Pivot Data for Race/Ethnicity and Age Group

county_race_age_summary <- asthma_ed_visits_2019_clean %>%
  group_by(county, race_ethnicity, age_group) %>%
  summarize(
    total_ed_visits = sum(number_of_ed_visits, na.rm = TRUE),
    mean_ed_visits = mean(number_of_ed_visits, na.rm = TRUE),  # Mean number of visits per group
    mean_age_adjusted_rate = mean(`age_adjusted_ed_visit_rate`, na.rm = TRUE),
    .groups = "drop"
  )

# Display the summary table
library(knitr)
kable(
  county_race_age_summary,
  col.names = c("County", "Race/Ethnicity", "Age Group", "Total ED Visits", "Mean ED Visits", "Mean Age-Adjusted Rate"),
  caption = "Table: Summary of ED Visits by County, Race/Ethnicity, and Age Group"
)


```

##Data Dictionary

New Variables for Analysis:
Dataset 1:


Dataset 2:
mean_CES_score: this is CES score by county as a simple mean
white: white race percentage as a weighted avg of total_population
black: black race percentage as a weighted avg of total_population
hispanic: hispanic race percentage as a weighted avg of total_population

Dataset 3:
county: The name of the county where the data is collected.
strata_name: Original demographic categorization, includes both age and race/ethnicity information
age_group: Age group of individuals visiting the ED
race_ethnicity: Race/ethnicity of individuals visiting the ED
age_category: Broader age categorization based on age_group
number_of_ed_visits: Total number of asthma-related ED visits for the specified demographic in 2019
age_adjusted_ed_visit_rate: Age-adjusted rate of ED visits per 100,000 population
total_ed_visits: Aggregated count of ED visits per county 
mean_ed_visits: Average number of ED visits per county or demographic subgroup
mean_age_adjusted_rate: Average age-adjusted ED visit rate per county or demographic subgroup