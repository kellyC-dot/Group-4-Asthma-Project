---
title: "Milestone 3"
author: "Avinia, Eve, Kelly"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown


```{r}
# Import dataset 1, 2 and 3 (Avinia to confirm if dataset 3 OK)

library(tidyverse)
library(dplyr)
library(readr)
library(janitor)

# Read Dataset 1 CSV with the specified arguments
asthma_measures <- readr::read_csv("data/calenviroscreen_measures_2021.csv", 
                            col_names = TRUE, 
                            col_types = NULL, 
                            skip = 0, 
                            skip_empty_rows = TRUE,
                            na = "NA")


# Then clean the names using janitor
asthma_measures <- janitor::clean_names(asthma_measures)

# next work with Dataset 2...
# Read Dataset 2 CSV with the specified arguments
asthma_scores_demog <- readr::read_csv("data/calenviroscreen_scores_demog_2021.csv", 
                            col_names = TRUE, 
                            col_types = NULL, 
                            skip = 0, 
                            skip_empty_rows = TRUE)

# Then clean the names using janitor
asthma_scores_demog <- janitor::clean_names(asthma_scores_demog)

# next work with Dataset 3...
# Read Dataset 3 CSV with the specified arguments
asthma_ER_rate_county <- readr::read_csv("data/asthma-emergency-department-visit-rates-by-county-2015_2022.csv", 
                            col_names = TRUE, 
                            col_types = NULL, 
                            skip = 0, 
                            skip_empty_rows = TRUE)

# Then clean the names using janitor
asthma_ER_rate_county <- janitor::clean_names(asthma_ER_rate_county)

print(asthma_measures);print(asthma_scores_demog);print(asthma_ER_rate_county)

```

## Dataset 1 Code:

```{r}

# Change to lower case and underscore, and rename column

asthma_measures_df <- asthma_measures %>% rename_with(~tolower(gsub(" ", "_", .x, fixed = TRUE)))

asthma_measures_df1 <- asthma_measures_df %>% 
  rename(county = california_county)


# selecting variables of interest, (11 variables, 8035 obs.)

asthma_measures_df2a <- asthma_measures_df1 %>% 
  select(census_tract, county, pm2_5, diesel_pm, 
         traffic, tox_release, asthma, housing_burden, 
         education, unemployment, poverty) 


# Remove rows with NA values in columns

asthma_measures_df2a_clean <- 
  asthma_measures_df2a[!is.na(asthma_measures_df2a$asthma) & !is.na(asthma_measures_df2a$pm2_5) & !is.na(asthma_measures_df2a$diesel_pm) & !is.na(asthma_measures_df2a$traffic) & !is.na(asthma_measures_df2a$tox_release) & !is.na(asthma_measures_df2a$housing_burden) & !is.na(asthma_measures_df2a$education) & !is.na(asthma_measures_df2a$unemployment) & !is.na(asthma_measures_df2a$poverty), ]


# Aggregate measure: median asthma rates and environmental variables by county 

asthma_measures_df3a <- asthma_measures_df2a_clean %>% 
  group_by(county) %>% 
  summarize(
    asthma_median_by_county = median(asthma, na.rm = TRUE),
    pm2_5_median_by_county = median(pm2_5, na.rm = TRUE),
    diesel_pm_median_by_county = median(diesel_pm, na.rm = TRUE),
    traffic_median_by_county = median(traffic, na.rm = TRUE),
    tox_release_median_by_county = median(tox_release, na.rm = TRUE),
    .groups = "drop"
  ) %>% 
  ungroup()
asthma_measures_df3a <- asthma_measures_df3a %>% 
  arrange(desc(asthma_median_by_county))


# Aggregate measure: median asthma rates and population characteristics 
# by county

asthma_measures_df3b <- asthma_measures_df2a_clean %>% 
  group_by(county) %>% 
  summarize(
    asthma_median_by_county = median(asthma, na.rm = TRUE),
    housing_burden_median_by_county = median(housing_burden, na.rm = TRUE),
    education_median_by_county = median(education, na.rm = TRUE),
    unemployment_median_by_county = median(unemployment, na.rm = TRUE),
    poverty_median_by_county = median(poverty, na.rm = TRUE),
    .groups = "drop"
  ) %>% 
  ungroup()
asthma_measures_df3b <- asthma_measures_df3b %>% 
  arrange(desc(asthma_median_by_county))

```

## Dataset 1 Tables and plot

```{r}

library(dplyr)
library(kableExtra)

# Median Asthma Rates and Environmental Factors by County

asthma_measures_df3a %>%
  setNames(c("County", "Asthma", "PM 2.5", "Diesel", "Traffic", "Toxic Release")) %>%  # rename columns
  mutate(across(c(Asthma, `PM 2.5`, Diesel, Traffic, `Toxic Release`), ~ round(.x, 3))) %>%  # Round columns to 3 digits
  kable(caption = "Median Asthma Rates and Environmental Factors by County") %>%  kable_styling(
    bootstrap_options = c("striped", "hover"),
    position = "center",
    full_width = FALSE
  ) %>%
  column_spec(1:ncol(asthma_measures_df3a), width = "5em") 


# Median Asthma Rates and Population Characteristics by County

asthma_measures_df3b %>%
  setNames(c("County", "Asthma", "Housing Burden", "Education", "Unemployment", "Poverty")) %>%  # rename columns
  mutate(across(c(Asthma, `Housing Burden`, Education, Unemployment, Poverty), ~ round(.x, 3))) %>%  # Round columns to 3 digits
  kable(caption = "Median Asthma Rates and Population Characteristics by County") %>%  kable_styling(
    bootstrap_options = c("striped", "hover"),
    position = "center",
    full_width = FALSE
  ) %>%
  column_spec(1:ncol(asthma_measures_df3a), width = "5em")  

# Data for plot Median Asthma Rates per County

asthma_measures_df13a <- asthma_measures_df3a %>%
mutate(county = factor(county, levels = county[order(asthma_median_by_county)]))

# Plotting

ggplot(asthma_measures_df13a, aes(x = county, y = asthma_median_by_county)) +
  geom_point() +  # Scatter plot points
  labs(
    x = "County",
    y = "Asthma Median",
    title = "Scatter Plot of Asthma Median per County"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1)  # Rotate x-axis labels
  )

```

## Dataset 2 Code:

```{r}
# In Dataset 2, standardize County names (remove spaces or case mismatches)
asthma_scores_demog <- asthma_scores_demog %>%
  clean_names()

```

## Dataset 3 Code:
```{r}
# Change to the lower case
asthma_ER_rate_county <- asthma_ER_rate_county %>%
  rename_with(~tolower(gsub(" ", "_", .x, fixed = TRUE)))

# Delete unnecessary column
asthma_ER_rate_county <- asthma_ER_rate_county %>%
  select(-comment)

# Filter the data for the year 2019
asthma_ed_visits_2019 <- asthma_ER_rate_county %>%
  filter(year == 2019)

# Recode Invalid Values
# Replace non-ASCII characters in both age_group and strata_name columns
asthma_ed_visits_2019 <- asthma_ed_visits_2019 %>%
  mutate(
    age_group = str_replace_all(age_group, "[^\x20-\x7E]", "-"),
    strata_name = str_replace_all(strata_name, "[^\x20-\x7E]", "-")
  )

# Check unique values to confirm the cleanup
unique(asthma_ed_visits_2019$age_group)
unique(asthma_ed_visits_2019$strata_name)

# Handle missing data
# Drop rows with NA values
library(tidyverse)

asthma_ed_visits_2019_clean <- asthma_ed_visits_2019 %>%
  drop_na()

str(asthma_ed_visits_2019_clean)
library(tidyverse)
# Descriptive stats per county
descriptive_stats_per_county <- asthma_ed_visits_2019_clean %>%
  group_by(county) %>%
  summarize(
    total_ed_visits = sum(number_of_ed_visits, na.rm = TRUE),
    avg_ed_visits = mean(number_of_ed_visits, na.rm = TRUE),
    median_ed_visits = median(number_of_ed_visits, na.rm = TRUE),
    sd_ed_visits = sd(number_of_ed_visits, na.rm = TRUE),
    min_ed_visits = min(number_of_ed_visits, na.rm = TRUE),
    max_ed_visits = max(number_of_ed_visits, na.rm = TRUE),
    
    avg_age_adjusted_rate = mean(`age_adjusted_ed_visit_rate`, na.rm = TRUE),
    median_age_adjusted_rate = median(`age_adjusted_ed_visit_rate`, na.rm = TRUE),
    sd_age_adjusted_rate = sd(`age_adjusted_ed_visit_rate`, na.rm = TRUE),
    min_age_adjusted_rate = min(`age_adjusted_ed_visit_rate`, na.rm = TRUE),
    max_age_adjusted_rate = max(`age_adjusted_ed_visit_rate`, na.rm = TRUE)
  )
print(descriptive_stats_per_county)


```
